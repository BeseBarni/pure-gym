# ADR 001: Asynchronous Decoupling of Hardware Systems via Outbox Pattern

## Status
Accepted

## Context
The gym system must interact with physical hardware (Revolving Doors, Locker Cabinets) in a 24/7 environment. 
* **Latency Sensitivity:** Users require immediate feedback when presenting credentials. Waiting for synchronous database writes (logs, ticket state updates) before opening a door causes unacceptable physical delays.
* **Reliability:** Network blips between the API and the database should not prevent a valid user from entering the gym if the application state is otherwise healthy in memory.
* **Data Integrity:** We must ensure that every physical access event is eventually recorded for security and auditing.

## Decision
We will decouple the `PureGym.API` from the physical hardware mocks (`Mock.CabinetSystem`, `Mock.RevolvingDoor`) using **RabbitMQ** and the **Transactional Outbox Pattern**.

1.  **Immediate Action:** When a user requests entry, the API validates the request and immediately publishes an intent event.
2.  **Outbox Pattern:** Instead of publishing directly to the queue, the event is written to a local "Outbox" table in the same transaction as any immediate domain state changes. A separate background process picks up these messages and pushes them to RabbitMQ.
3.  **Consumption:** The Hardware systems (Mocks) listen to the queue and actuate the hardware and publish a GymEntered event.
4.  **Logging:** Heavy write operations (access logs, non-critical state updates) are processed asynchronously by consuming the events, removing them from the critical path of the user's entry.

## Consequences
* **Positive:** "Letting the user in" is extremely fast. The system is resilient to transient database slowness regarding log ingestion.
* **Positive:** Guarantees at-least-once delivery of hardware commands.
* **Negative:** Eventual consistency. The "Access Logs" reporting view may lag slightly behind real-time events (by milliseconds to seconds).