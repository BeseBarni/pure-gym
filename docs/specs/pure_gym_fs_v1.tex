\documentclass[11pt, a4paper]{article}

% Essential Packages
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{enumitem}

% Geometry Settings
\geometry{
    left=25mm,
    right=25mm,
    top=25mm,
    bottom=25mm
}

% Hyperlink Setup
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={PureGym Functional Specification},
    pdfpagemode=FullScreen,
}

% Header and Footer
\pagestyle{fancy}
\fancyhf{}
\rhead{PureGym System Design}
\lhead{Functional Specification v1.0}
\cfoot{\thepage}

% Title Page Information
\title{
    \vspace{2cm}
    \textbf{\Huge PureGym Management System} \\
    \vspace{0.5cm}
    \Large Functional Specification Document \\
    \vspace{0.5cm}
    \large Version 1.0
}
\author{Bese BarnabÃ¡s}
\date{February 26, 2026}

\begin{document}

\maketitle
\thispagestyle{empty}

\begin{center}
    \vspace{2cm}
    \textbf{Abstract} \\
    \vspace{0.5cm}
    \begin{minipage}{0.8\textwidth}
        This document outlines the functional requirements for the PureGym autonomous gym management system. It details the core logic for authentication, membership management, physical access control via QR codes, locker management, and administrative operations. The system is designed for high availability and low latency access control.
    \end{minipage}
\end{center}

\newpage

% Table of Contents
\tableofcontents
\newpage

\section{Document Control}

\begin{table}[h]
    \centering
    \begin{tabularx}{\textwidth}{l l X}
        \toprule
        \textbf{Date} & \textbf{Version} & \textbf{Change Description} \\
        \midrule
        2026-02-26 & 1.0 & Initial Draft based on architectural decisions (ADRs) and feature scope. \\
        \bottomrule
    \end{tabularx}
\end{table}

\section{Actors and Roles}

The following actors interact with the system boundaries:

\begin{table}[h]
    \renewcommand{\arraystretch}{1.5}
    \begin{tabularx}{\textwidth}{@{}l X@{}}
        \toprule
        \textbf{Actor} & \textbf{Description} \\
        \midrule
        Guest & An unauthenticated user browsing the public website/app. \\
        Member & An authenticated user (Standard Role). May or may not have an active membership. \\
        Admin & A privileged user with access to back-office configuration, logs, and user management. \\
        System (Worker) & Background processes handling time-based events (notifications) and asynchronous tasks (logging, outbox processing). \\
        Hardware Mock & Simulates physical devices (Revolving Doors, Locker Cabinets) and consumes hardware events. \\
        \bottomrule
    \end{tabularx}
\end{table}

\section{Functional Requirements}

\subsection{Authentication \& Identity (AUTH)}
The system relies on stateless authentication to support scalability.

\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[AUTH-01] \textbf{Login/Registration.} Users must be able to create an account or log in using:
    \begin{itemize}
        \item Local credentials (Email/Password).
        \item Google OAuth 2.0 provider.
    \end{itemize}
    
    \item[AUTH-02] \textbf{Session Management.} The system uses stateless JWT (JSON Web Tokens). The token is issued upon login and must be included in the \texttt{Authorization} header of subsequent requests.
    
    \item[AUTH-03] \textbf{Role-Based Access.} The JWT contains claims distinguishing between \texttt{Member} and \texttt{Admin} roles to enforce API authorization policies.
\end{description}

\subsection{Membership \& Payments (MEM)}
\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[MEM-01] \textbf{Purchase Initiation.} Upon selecting a membership type:
    \begin{enumerate}
        \item System creates an \texttt{Order} record in "Pending" state.
        \item System pushes an \texttt{OrderCreated} event.
        \item Client is redirected to the external Payment Service.
    \end{enumerate}
    
    \item[MEM-02] \textbf{Payment Processing.} The Payment Service processes the transaction. On success, a webhook is sent back to the API.
    
    \item[MEM-03] \textbf{Activation.} Upon receiving the \texttt{PaymentSuccess} event:
    \begin{itemize}
        \item The Order state updates to "Completed".
        \item The Member's status is set to Active (or tickets are incremented).
    \end{itemize}
\end{description}

\subsection{Physical Access Control (ACS)}
Performance is prioritized over immediate database persistence to ensure rapid entry.

\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[ACS-01] \textbf{QR Generation.} A Member can request an entry QR code.
    \begin{itemize}
        \item System generates a secure OTP (One Time Password).
        \item OTP is stored in \textbf{In-Memory Cache} for low latency.
    \end{itemize}
    
    \item[ACS-02] \textbf{Entry Validation.} When the QR is scanned at the `EnterGym` endpoint:
    \begin{itemize}
        \item System validates OTP against in-memory state.
        \item \textbf{Rules:} Member must have active subscription OR $>0$ tickets. Member must not be banned.
        \item \textbf{Success:} Returns immediate HTTP 200 OK to hardware mock to open door.
    \end{itemize}
    
    \item[ACS-03] \textbf{Async Processing.} After granting access, the system asynchronously:
    \begin{itemize}
        \item Publishes a \texttt{UserEntered} event via the Outbox pattern.
        \item Deducts a ticket (if applicable).
        \item Persists entry in \texttt{AccessLog} table.
    \end{itemize}
\end{description}

\subsection{Locker Management (LCK)}
\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[LCK-01] \textbf{Cabinet Action.} Members can request to Lock/Unlock a specific cabinet ID.
    \item[LCK-02] \textbf{Authorization.} System verifies ownership/rental status of the cabinet.
    \item[LCK-03] \textbf{Real-time Feedback.} System uses \textbf{Server-Sent Events (SSE)} to push status changes (\texttt{LockerLocked}, \texttt{LockerUnlocked}) to the client UI immediately after hardware confirmation.
\end{description}

\subsection{Notifications (NOT)}
\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[NOT-01] \textbf{Expiration Warning.} A background worker scans for memberships expiring in $< 3$ days and triggers an email notification.
    \item[NOT-02] \textbf{Low Ticket Warning.} A background worker scans for users with $< 3$ tickets remaining and triggers an email notification.
    \item[NOT-03] \textbf{Frequency Cap.} Notifications are capped to prevent spam (e.g., max 1 per 24h).
\end{description}

\subsection{Administration (ADM)}
\begin{description}[style=multiline, leftmargin=3cm, font=\bfseries]
    \item[ADM-01] \textbf{Membership Types.} Admins can Create, Update (price/benefits), or Invalidate (soft-delete) membership tiers.
    \item[ADM-02] \textbf{User Management.} Admins can list users, view profiles, and force-add memberships to users (e.g., for support/cash payments).
    \item[ADM-03] \textbf{Audit Logs.} Admins have read-only access to \texttt{GymEntered} and \texttt{CabinetAccessed} logs.
\end{description}

\section{Data Flow \& State Machines}

\subsection{Membership Lifecycle}
The membership status transitions through the following states:
\begin{enumerate}
    \item \textbf{None:} User has no active plan.
    \item \textbf{Pending:} Purchase initiated, awaiting payment provider callback.
    \item \textbf{Active:} Payment confirmed, access rights granted.
    \item \textbf{Expired:} Duration elapsed or ticket count reached zero.
    \item \textbf{Cancelled:} Access revoked by Administrator.
\end{enumerate}

\subsection{Door Entry Sequence (Happy Path)}
\begin{enumerate}
    \item \textbf{Client:} Request QR Code.
    \item \textbf{API:} Validate Member and Membership $\rightarrow$ Generate OTP $\rightarrow$ Store in RAM $\rightarrow$ Return QR.
    \item \textbf{Hardware:} Scan QR $\rightarrow$ Send to API.
    \item \textbf{API:} Validate OTP (RAM) $\rightarrow$ Send out GymEntryRequestEvent $\rightarrow$ Return OK $\rightarrow$ \textbf{Hardware Opens Door}.
    \item \textbf{API (Async):} Publish Event $\rightarrow$ Worker consumes $\rightarrow$ Write DB Log / Decrement Ticket.
\end{enumerate}

\end{document}